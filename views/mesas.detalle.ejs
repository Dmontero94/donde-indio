<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Mesa <%= mesa.numero %> - Donde Indio</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="p-4">
    <div class="container">

            <!-- NAVBAR -->
      <%- include('partials/navbar') %>

      <a href="/mesas" class="btn btn-secondary mb-3">‚¨Ö Volver</a>

      <h1>Mesa <%= mesa.numero %></h1>
      <p>
        Estado:
        <strong class="<%= mesa.estado === 'ocupada' ? 'text-danger' : 'text-success' %>">
          <%= mesa.estado %>
        </strong>
      </p>

      <% if (mesa.estado === 'libre') { %>
        <!-- Mesa libre: bot√≥n para abrir cuenta -->
        <a href="/mesas/<%= mesa.numero %>/abrir" class="btn btn-primary mb-3">
          Abrir cuenta
        </a>

      <% } else { %>
        <!-- Mesa ocupada: formulario para agregar productos -->
                 <h3>Total: ‚Ç°<%= mesa.cuentaActual.total %></h3>

        <a
          href="/mesas/<%= mesa.numero %>/cobrar"
          class="btn btn-warning mt-3"
        >
          Cobrar mesa
        </a>

        <h3 class="mt-3">Agregar producto a la cuenta</h3>

        <form
          class="row g-2 mb-4"
          action="/mesas/<%= mesa.numero %>/items"
          method="POST"
        >
          <div class="col-md-8">
            <label for="productoId" class="form-label">Producto</label>
            <select
              class="form-select"
              id="productoId"
              name="productoId"
              required
            >
              <option value="">Seleccione un producto...</option>
              <% productos.forEach(prod => { %>
                <option value="<%= prod._id %>">
                  <%= prod.categoria %> - <%= prod.nombre %> (‚Ç°<%= prod.precio %>)
                </option>
              <% }) %>
            </select>
          </div>

          <div class="col-md-2">
            <label for="cantidad" class="form-label">Cantidad</label>
            <input
              type="number"
              class="form-control"
              id="cantidad"
              name="cantidad"
              min="1"
              value="1"
              required
            />
          </div>

          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">
              Agregar
            </button>
          </div>
        </form>

        <h3>Cuenta actual</h3>

        <% if (!mesa.cuentaActual || !mesa.cuentaActual.items || mesa.cuentaActual.items.length === 0) { %>
          <p>No hay productos registrados a√∫n.</p>
        <% } else { %>

          <table class="table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cant</th>
                <th>Precio</th>
                <th>Subtotal</th>
              </tr>
            </thead>
                <tbody>
      <% mesa.cuentaActual.items.forEach(item => { %>
        <tr>
          <td><%= item.nombreProducto %></td>

          <!-- COLUMNA CANTIDAD CON BOTONES - / + -->
          <td>
            <form
              action="/mesas/<%= mesa.numero %>/items/<%= item._id %>/decrease"
              method="POST"
              class="d-inline"
            >
              <button class="btn btn-sm btn-outline-secondary" title="Disminuir">
                ‚ûñ
              </button>
            </form>

            <span class="mx-2"><%= item.cantidad %></span>

            <form
              action="/mesas/<%= mesa.numero %>/items/<%= item._id %>/increase"
              method="POST"
              class="d-inline"
            >
              <button class="btn btn-sm btn-outline-secondary" title="Aumentar">
                ‚ûï
              </button>
            </form>
          </td>

          <td>‚Ç°<%= item.precioUnitario.toLocaleString("es-CR") %></td>
          <td>‚Ç°<%= item.subtotal.toLocaleString("es-CR") %></td>

          <!-- COLUMNA ELIMINAR CON CONFIRMACI√ìN -->
          <td>
            <form
              action="/mesas/<%= mesa.numero %>/items/<%= item._id %>/delete"
              method="POST"
              style="display:inline;"
              onsubmit="return confirm('¬øSeguro que quiere eliminar este producto?');"
            >
              <button class="btn btn-sm btn-danger" title="Eliminar producto">
                üóëÔ∏è
              </button>
            </form>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
<% } %>
                </tr>
              <% }) %>
            </tbody>
          </table>

          <h3>Total: ‚Ç°<%= mesa.cuentaActual.total %></h3>

        <% } %>

      <% } %>

      <!-- Puedes dejar esto por mientras para debug si quieres
      <hr />
      <h5>Debug mesa:</h5>
      <pre><%= JSON.stringify(mesa, null, 2) %></pre>
      -->

    </div>
  </body>
</html>