<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Detalle de mesa - Donde Indio</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-light">
    <div class="container py-4">
      <!-- NAVBAR -->
      <%- include('partials/navbar') %>

      <!-- ENCABEZADO -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0">Mesa <%= mesa.numero %></h1>

        <a href="/mesas" class="btn btn-secondary btn-sm">
          ‚¨Ö Volver a mesas
        </a>
      </div>

      <p class="mb-3">
        <strong>Estado:</strong>
        <% if (mesa.estado === 'ocupada') { %>
          <span class="badge bg-danger">Ocupada</span>
        <% } else if (mesa.estado === 'libre') { %>
          <span class="badge bg-success">Libre</span>
        <% } else { %>
          <span class="badge bg-warning text-dark"><%= mesa.estado %></span>
        <% } %>
      </p>

      <!-- FORMULARIO: AGREGAR PRODUCTO -->
      <div class="card mb-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Agregar producto a la cuenta</h2>

          <form
            action="/mesas/<%= mesa.numero %>/items"
            method="POST"
            class="row g-2 align-items-end"
          >
            <div class="col-md-6">
              <label for="productoId" class="form-label">Producto</label>
              <select
                id="productoId"
                name="productoId"
                class="form-select"
                required
              >
                <option value="">Seleccionar...</option>
                <% if (productos && productos.length > 0) { %>
                  <% productos.forEach(function(prod) { %>
                    <option value="<%= prod._id %>">
                      <%= prod.categoria %> - <%= prod.nombre %> (‚Ç°<%= prod.precio.toLocaleString('es-CR') %>)
                    </option>
                  <% }); %>
                <% } %>
              </select>
            </div>

            <div class="col-md-3">
              <label for="cantidad" class="form-label">Cantidad</label>
              <input
                type="number"
                min="1"
                value="1"
                id="cantidad"
                name="cantidad"
                class="form-control"
                required
              />
            </div>

            <div class="col-md-3">
              <button type="submit" class="btn btn-primary w-100">
                Agregar
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- LISTA DE PRODUCTOS EN LA CUENTA -->
      <% if (mesa.cuentaActual && mesa.cuentaActual.items && mesa.cuentaActual.items.length > 0) { %>
        <h3 class="h5 mt-4">Productos en la cuenta</h3>

        <table class="table table-sm align-middle mt-2">
          <thead>
            <tr>
              <th>Producto</th>
              <th style="width: 200px;">Cantidad</th>
              <th>Precio unitario</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% mesa.cuentaActual.items.forEach(function(item) { %>
              <tr>
                <td><%= item.nombreProducto %></td>

                <!-- COLUMNA CANTIDAD CON BOTONES - / + -->
                <td>
                  <form
                    action="/mesas/<%= mesa.numero %>/items/<%= item._id %>/decrease"
                    method="POST"
                    class="d-inline"
                  >
                    <button
                      type="submit"
                      class="btn btn-sm btn-outline-secondary"
                      title="Disminuir cantidad"
                    >
                      ‚ûñ
                    </button>
                  </form>

                  <span class="mx-2"><%= item.cantidad %></span>

                  <form
                    action="/mesas/<%= mesa.numero %>/items/<%= item._id %>/increase"
                    method="POST"
                    class="d-inline"
                  >
                    <button
                      type="submit"
                      class="btn btn-sm btn-outline-secondary"
                      title="Aumentar cantidad"
                    >
                      ‚ûï
                    </button>
                  </form>
                </td>

                <td>‚Ç°<%= item.precioUnitario.toLocaleString('es-CR') %></td>
                <td>‚Ç°<%= item.subtotal.toLocaleString('es-CR') %></td>

                <!-- ELIMINAR ITEM CON CONFIRMACI√ìN -->
                <td>
                  <form
                    action="/mesas/<%= mesa.numero %>/items/<%= item._id %>/delete"
                    method="POST"
                    style="display:inline;"
                    onsubmit="return confirm('¬øSeguro que quiere eliminar este producto?');"
                  >
                    <button
                      type="submit"
                      class="btn btn-sm btn-danger"
                      title="Eliminar producto"
                    >
                      üóëÔ∏è
                    </button>
                  </form>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>

        <!-- TOTAL Y BOT√ìN COBRAR -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <h4 class="h5 mb-0">
            Total: ‚Ç°<%= mesa.cuentaActual.total.toLocaleString('es-CR') %>
          </h4>

          <a
            href="/mesas/<%= mesa.numero %>/cobrar"
            class="btn btn-success"
          >
            Cobrar
          </a>
        </div>
      <% } else { %>
        <p class="mt-4 text-muted">
          No hay productos en la cuenta actual.
        </p>
      <% } %>

    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    ></script>
  </body>
</html>