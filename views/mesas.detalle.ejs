<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Detalle de mesa - Donde Indio</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-light">
    <div class="container py-4">
      <!-- NAVBAR -->
      <%- include('partials/navbar') %>

      <!-- ENCABEZADO -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <% const isBarraHeader = mesa.numero > 10; %>
        <h1 class="h3 mb-0"><%= isBarraHeader ? 'Barra ' + (mesa.numero - 10) : 'Mesa ' + mesa.numero %></h1>

        <a href="/mesas" class="btn btn-secondary btn-sm">
          ‚¨Ö Volver a mesas
        </a>
      </div>

      <p class="mb-3">
        <strong>Estado:</strong>
        <% if (mesa.estado === 'ocupada') { %>
          <span class="badge bg-danger">Ocupada</span>
        <% } else if (mesa.estado === 'libre') { %>
          <span class="badge bg-success">Libre</span>
        <% } else { %>
          <span class="badge bg-warning text-dark"><%= mesa.estado %></span>
        <% } %>
      </p>

      <!-- FORMULARIO: AGREGAR PRODUCTO -->
      <div class="card mb-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Agregar producto a la cuenta</h2>

          <form
            id="formAgregarProducto"
            action="/mesas/<%= mesa.numero %>/items"
            method="POST"
            class="row g-2 align-items-end"
          >
            <div class="col-md-6">
              <ul class="nav nav-tabs mb-2" id="productoTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="tab-select" data-bs-toggle="tab" data-bs-target="#contenido-select" type="button" role="tab">
                    Men√∫
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="tab-buscar" data-bs-toggle="tab" data-bs-target="#contenido-buscar" type="button" role="tab">
                    Buscar
                  </button>
                </li>
              </ul>
              
              <div class="tab-content" id="productoTabContent">
                <!-- TAB 1: MEN√ö SELECT ORIGINAL -->
                <div class="tab-pane fade show active" id="contenido-select" role="tabpanel">
                  <label for="productoId" class="form-label">Producto</label>
                  <select
                    id="productoId"
                    name="productoId"
                    class="form-select"
                  >
                    <option value="">Seleccionar...</option>
                    <% if (productos && productos.length > 0) { %>
                      <% productos.forEach(function(prod) { %>
                        <option value="<%= prod._id %>">
                          <%= prod.categoria %> - <%= prod.nombre %> (‚Ç°<%= prod.precio.toLocaleString('es-CR') %>)
                        </option>
                      <% }); %>
                    <% } %>
                  </select>
                </div>

                <!-- TAB 2: BUSCADOR -->
                <div class="tab-pane fade" id="contenido-buscar" role="tabpanel">
                  <label for="productoBuscar" class="form-label">Buscar producto</label>
                  <div class="position-relative">
                    <input
                      type="text"
                      id="productoBuscar"
                      class="form-control"
                      placeholder="Escribe el nombre del producto..."
                      autocomplete="off"
                    />
                    <div
                      id="productosLista"
                      class="list-group position-absolute w-100 mt-1"
                      style="max-height: 300px; overflow-y: auto; display: none; z-index: 1000; background: white; border: 1px solid #dee2e6;"
                    ></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-3">
              <label for="cantidad" class="form-label">Cantidad</label>
              <input
                type="number"
                min="1"
                value="1"
                id="cantidad"
                name="cantidad"
                class="form-control"
                required
              />
            </div>

            <div class="col-md-3">
              <button type="submit" class="btn btn-primary w-100">
                Agregar
              </button>
            </div>
          </form>
        </div>
      </div>
            <!-- FORMULARIO: AGREGAR EXTRA PERSONALIZADO -->
      <div class="card mb-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Agregar extra personalizado</h2>
          <p class="text-muted small mb-3">
            Para √≥rdenes especiales, solo prote√≠na, cambios en acompa√±amientos, etc.
          </p>

          <form
            action="/mesas/<%= mesa.numero %>/extras"
            method="POST"
            class="row g-2 align-items-end"
          >
            <div class="col-md-6">
              <label for="descripcionExtra" class="form-label">
                Descripci√≥n
              </label>
              <input
                type="text"
                id="descripcionExtra"
                name="descripcion"
                class="form-control"
                placeholder="Ej: Solo carne con ensalada, sin arroz"
                required
              />
            </div>

            <div class="col-md-3">
              <label for="montoExtra" class="form-label">
                Monto (‚Ç°)
              </label>
              <input
                type="number"
                min="0"
                step="50"
                value="0"
                id="montoExtra"
                name="monto"
                class="form-control"
                required
              />
            </div>

            <div class="col-md-3">
              <button type="submit" class="btn btn-outline-primary w-100">
                Agregar extra
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- LISTA DE PRODUCTOS EN LA CUENTA -->
      <% if (mesa.cuentaActual && mesa.cuentaActual.items && mesa.cuentaActual.items.length > 0) { %>
        <h3 class="h5 mt-4">Productos en la cuenta</h3>

        <table class="table table-sm align-middle mt-2">
          <thead>
            <tr>
              <th>Producto</th>
              <th style="width: 200px;">Cantidad</th>
              <th>Precio unitario</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% mesa.cuentaActual.items.forEach(function(item) { %>
              <tr>
                <td><%= item.nombreProducto %></td>

                <!-- COLUMNA CANTIDAD CON BOTONES - / + -->
                <td>
                  <form
                    action="/mesas/<%= mesa.numero %>/items/<%= item._id %>/decrease"
                    method="POST"
                    class="d-inline"
                  >
                    <button
                      type="submit"
                      class="btn btn-sm btn-outline-secondary"
                      title="Disminuir cantidad"
                    >
                      ‚ûñ
                    </button>
                  </form>

                  <span class="mx-2"><%= item.cantidad %></span>

                  <form
                    action="/mesas/<%= mesa.numero %>/items/<%= item._id %>/increase"
                    method="POST"
                    class="d-inline"
                  >
                    <button
                      type="submit"
                      class="btn btn-sm btn-outline-secondary"
                      title="Aumentar cantidad"
                    >
                      ‚ûï
                    </button>
                  </form>
                </td>

                <td>‚Ç°<%= item.precioUnitario.toLocaleString('es-CR') %></td>
                <td>‚Ç°<%= item.subtotal.toLocaleString('es-CR') %></td>

                <!-- ELIMINAR ITEM CON CONFIRMACI√ìN -->
                <td>
                  <form
                    action="/mesas/<%= mesa.numero %>/items/<%= item._id %>/delete"
                    method="POST"
                    style="display:inline;"
                    onsubmit="return confirm('¬øSeguro que quiere eliminar este producto?');"
                  >
                    <button
                      type="submit"
                      class="btn btn-sm btn-danger"
                      title="Eliminar producto"
                    >
                      üóëÔ∏è
                    </button>
                  </form>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>

        <!-- TOTAL Y BOT√ìN COBRAR -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <h4 class="h5 mb-0">
            Total: ‚Ç°<%= mesa.cuentaActual.total.toLocaleString('es-CR') %>
          </h4>

          <a
            href="/mesas/<%= mesa.numero %>/cobrar"
            class="btn btn-success"
          >
            Cobrar
          </a>
        </div>
      <% } else { %>
        <p class="mt-4 text-muted">
          No hay productos en la cuenta actual.
        </p>
      <% } %>

    </div>

    <script>
      // Productos disponibles desde el servidor
      const productos = <%- JSON.stringify(productos) %>;
      const inputBuscar = document.getElementById("productoBuscar");
      const inputSelectMenu = document.getElementById("productoId");
      const listaProductos = document.getElementById("productosLista");
      const formAgregarProducto = document.getElementById("formAgregarProducto");

      // Validar el formulario antes de enviar
      formAgregarProducto.addEventListener("submit", function(e) {
        if (!inputSelectMenu.value) {
          e.preventDefault();
          alert("Por favor selecciona un producto");
          return false;
        }
      });

      // Filtrar y mostrar sugerencias mientras escribes
      inputBuscar.addEventListener("input", function() {
        const busqueda = this.value.toLowerCase().trim();

        if (busqueda.length === 0) {
          listaProductos.style.display = "none";
          return;
        }

        // Filtrar productos que coincidan con la b√∫squeda
        const sugerencias = productos.filter(prod => 
          prod.nombre.toLowerCase().includes(busqueda) ||
          prod.categoria.toLowerCase().includes(busqueda)
        );

        // Mostrar sugerencias
        if (sugerencias.length > 0) {
          listaProductos.innerHTML = sugerencias.map(prod => `
            <button 
              type="button"
              class="list-group-item list-group-item-action text-start" 
              data-id="${prod._id}"
              data-label="${prod.categoria} - ${prod.nombre} (‚Ç°${prod.precio.toLocaleString('es-CR')})"
              style="border: none; background: none; padding: 0.75rem 1.25rem; width: 100%; text-align: left;"
            >
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${prod.categoria} - ${prod.nombre}</h6>
                <span class="text-muted">‚Ç°${prod.precio.toLocaleString('es-CR')}</span>
              </div>
            </button>
          `).join("");
          
          // Agregar event listeners a los botones
          const botones = listaProductos.querySelectorAll("button");
          botones.forEach(btn => {
            btn.addEventListener("click", function(e) {
              e.preventDefault();
              const id = this.getAttribute("data-id");
              const label = this.getAttribute("data-label");
              selectProductoBuscar(id, label);
            });
          });
          
          listaProductos.style.display = "block";
        } else {
          listaProductos.innerHTML = '<div class="list-group-item text-muted">No se encontraron productos</div>';
          listaProductos.style.display = "block";
        }
      });

      // Seleccionar un producto del buscador
      function selectProductoBuscar(id, label) {
        inputSelectMenu.value = id;
        inputBuscar.value = label;
        listaProductos.style.display = "none";
      }

      // Cerrar lista al hacer click fuera
      document.addEventListener("click", function(e) {
        if (e.target !== inputBuscar && !listaProductos.contains(e.target)) {
          listaProductos.style.display = "none";
        }
      });

      // Permitir cerrar la lista con ESC
      inputBuscar.addEventListener("keydown", function(e) {
        if (e.key === "Escape") {
          listaProductos.style.display = "none";
        }
      });
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    ></script>
  </body>
</html>